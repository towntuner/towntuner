import { useSortable } from "@dnd-kit/sortable";
import { twMerge } from "tailwind-merge";
import { CSS } from "@dnd-kit/utilities";
import { Question } from "@/types/questions";
import QuestionBlock from "./question";

interface PackageProps {
  item: Question;
  onEdit?: () => void;
}

export function DraggablePackage({ item, onEdit }: PackageProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
    setActivatorNodeRef,
  } = useSortable({ id: item.title });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  function DragHandle({ className }: { className?: string }) {
    return (
      <div
        ref={setActivatorNodeRef}
        className={twMerge("h-full w-6", className)}
        {...listeners}
        {...attributes}
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M9 6.75C8.80109 6.75 8.61032 6.67098 8.46967 6.53033C8.32902 6.38968 8.25 6.19891 8.25 6C8.25 5.80109 8.32902 5.61032 8.46967 5.46967C8.61032 5.32902 8.80109 5.25 9 5.25C9.19891 5.25 9.38968 5.32902 9.53033 5.46967C9.67098 5.61032 9.75 5.80109 9.75 6C9.75 6.19891 9.67098 6.38968 9.53033 6.53033C9.38968 6.67098 9.19891 6.75 9 6.75ZM9 12.75C8.80109 12.75 8.61032 12.671 8.46967 12.5303C8.32902 12.3897 8.25 12.1989 8.25 12C8.25 11.8011 8.32902 11.6103 8.46967 11.4697C8.61032 11.329 8.80109 11.25 9 11.25C9.19891 11.25 9.38968 11.329 9.53033 11.4697C9.67098 11.6103 9.75 11.8011 9.75 12C9.75 12.1989 9.67098 12.3897 9.53033 12.5303C9.38968 12.671 9.19891 12.75 9 12.75ZM9 18.75C8.80109 18.75 8.61032 18.671 8.46967 18.5303C8.32902 18.3897 8.25 18.1989 8.25 18C8.25 17.8011 8.32902 17.6103 8.46967 17.4697C8.61032 17.329 8.80109 17.25 9 17.25C9.19891 17.25 9.38968 17.329 9.53033 17.4697C9.67098 17.6103 9.75 17.8011 9.75 18C9.75 18.1989 9.67098 18.3897 9.53033 18.5303C9.38968 18.671 9.19891 18.75 9 18.75Z"
            stroke="black"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M15 6.75C14.8011 6.75 14.6103 6.67098 14.4697 6.53033C14.329 6.38968 14.25 6.19891 14.25 6C14.25 5.80109 14.329 5.61032 14.4697 5.46967C14.6103 5.32902 14.8011 5.25 15 5.25C15.1989 5.25 15.3897 5.32902 15.5303 5.46967C15.671 5.61032 15.75 5.80109 15.75 6C15.75 6.19891 15.671 6.38968 15.5303 6.53033C15.3897 6.67098 15.1989 6.75 15 6.75ZM15 12.75C14.8011 12.75 14.6103 12.671 14.4697 12.5303C14.329 12.3897 14.25 12.1989 14.25 12C14.25 11.8011 14.329 11.6103 14.4697 11.4697C14.6103 11.329 14.8011 11.25 15 11.25C15.1989 11.25 15.3897 11.329 15.5303 11.4697C15.671 11.6103 15.75 11.8011 15.75 12C15.75 12.1989 15.671 12.3897 15.5303 12.5303C15.3897 12.671 15.1989 12.75 15 12.75ZM15 18.75C14.8011 18.75 14.6103 18.671 14.4697 18.5303C14.329 18.3897 14.25 18.1989 14.25 18C14.25 17.8011 14.329 17.6103 14.4697 17.4697C14.6103 17.329 14.8011 17.25 15 17.25C15.1989 17.25 15.3897 17.329 15.5303 17.4697C15.671 17.6103 15.75 17.8011 15.75 18C15.75 18.1989 15.671 18.3897 15.5303 18.5303C15.3897 18.671 15.1989 18.75 15 18.75Z"
            stroke="black"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
    );
  }

  return (
    <div
      className={twMerge(
        "relative left-0 top-0 flex touch-none gap-2",
        isDragging && "opacity-0"
      )}
      ref={setNodeRef}
      style={style}
    >
      <DragHandle className="absolute -left-8 top-0 mt-3 hidden md:block" />
      <QuestionBlock
        question={item}
        className="w-full"
        dragHandle={<DragHandle className="md:hidden" />}
      />
    </div>
  );
}

interface OverlayPackageProps {
  item: Question;
}

export function DraggablePackageOverlay({ item }: OverlayPackageProps) {
  function DragHandle({ className }: { className?: string }) {
    return (
      <div className={twMerge("h-full w-6", className)}>
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M9 6.75C8.80109 6.75 8.61032 6.67098 8.46967 6.53033C8.32902 6.38968 8.25 6.19891 8.25 6C8.25 5.80109 8.32902 5.61032 8.46967 5.46967C8.61032 5.32902 8.80109 5.25 9 5.25C9.19891 5.25 9.38968 5.32902 9.53033 5.46967C9.67098 5.61032 9.75 5.80109 9.75 6C9.75 6.19891 9.67098 6.38968 9.53033 6.53033C9.38968 6.67098 9.19891 6.75 9 6.75ZM9 12.75C8.80109 12.75 8.61032 12.671 8.46967 12.5303C8.32902 12.3897 8.25 12.1989 8.25 12C8.25 11.8011 8.32902 11.6103 8.46967 11.4697C8.61032 11.329 8.80109 11.25 9 11.25C9.19891 11.25 9.38968 11.329 9.53033 11.4697C9.67098 11.6103 9.75 11.8011 9.75 12C9.75 12.1989 9.67098 12.3897 9.53033 12.5303C9.38968 12.671 9.19891 12.75 9 12.75ZM9 18.75C8.80109 18.75 8.61032 18.671 8.46967 18.5303C8.32902 18.3897 8.25 18.1989 8.25 18C8.25 17.8011 8.32902 17.6103 8.46967 17.4697C8.61032 17.329 8.80109 17.25 9 17.25C9.19891 17.25 9.38968 17.329 9.53033 17.4697C9.67098 17.6103 9.75 17.8011 9.75 18C9.75 18.1989 9.67098 18.3897 9.53033 18.5303C9.38968 18.671 9.19891 18.75 9 18.75Z"
            stroke="black"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M15 6.75C14.8011 6.75 14.6103 6.67098 14.4697 6.53033C14.329 6.38968 14.25 6.19891 14.25 6C14.25 5.80109 14.329 5.61032 14.4697 5.46967C14.6103 5.32902 14.8011 5.25 15 5.25C15.1989 5.25 15.3897 5.32902 15.5303 5.46967C15.671 5.61032 15.75 5.80109 15.75 6C15.75 6.19891 15.671 6.38968 15.5303 6.53033C15.3897 6.67098 15.1989 6.75 15 6.75ZM15 12.75C14.8011 12.75 14.6103 12.671 14.4697 12.5303C14.329 12.3897 14.25 12.1989 14.25 12C14.25 11.8011 14.329 11.6103 14.4697 11.4697C14.6103 11.329 14.8011 11.25 15 11.25C15.1989 11.25 15.3897 11.329 15.5303 11.4697C15.671 11.6103 15.75 11.8011 15.75 12C15.75 12.1989 15.671 12.3897 15.5303 12.5303C15.3897 12.671 15.1989 12.75 15 12.75ZM15 18.75C14.8011 18.75 14.6103 18.671 14.4697 18.5303C14.329 18.3897 14.25 18.1989 14.25 18C14.25 17.8011 14.329 17.6103 14.4697 17.4697C14.6103 17.329 14.8011 17.25 15 17.25C15.1989 17.25 15.3897 17.329 15.5303 17.4697C15.671 17.6103 15.75 17.8011 15.75 18C15.75 18.1989 15.671 18.3897 15.5303 18.5303C15.3897 18.671 15.1989 18.75 15 18.75Z"
            stroke="black"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
    );
  }

  if (!item) return null;

  return (
    <div className="relative flex touch-none gap-2">
      <DragHandle className="absolute -left-8 top-0 mt-3 hidden cursor-grabbing md:block" />
      <QuestionBlock
        question={item}
        className="w-full bg-white"
        dragHandle={<DragHandle className="cursor-grabbing md:hidden" />}
      />
    </div>
  );
}
